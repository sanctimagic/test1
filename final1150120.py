# -*- coding: utf-8 -*-
"""final1150120.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/180inZLkL0tUz9rCraHnUMjSxzKMI-bNq
"""

# 1. å®‰è£ Selenium
!pip install selenium

# 2. ä¸‹è¼‰ä¸¦å®‰è£ Google Chrome å®˜æ–¹ç©©å®šç‰ˆ (ç”± Google ä¼ºæœå™¨ç›´æŽ¥ä¸‹è¼‰ï¼Œç¢ºä¿å®Œæ•´)
!wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
!apt-get install -y ./google-chrome-stable_current_amd64.deb

# 3. è‡ªå‹•ä¿®æ­£ä¾è³´é—œä¿‚ (é€™æ˜¯è§£æ±º Status Code 1 çš„é—œéµ)
!apt-get -f install -y

# 4. å®‰è£ä¸­æ–‡å­—åž‹
!apt-get install -y fonts-noto-cjk

# 5. æ¸…ç†æ®˜å­˜æª”
!rm google-chrome-stable_current_amd64.deb

print("ç’°å¢ƒå®‰è£å®Œæˆï¼è«‹ç¹¼çºŒåŸ·è¡Œä¸‹ä¸€æ­¥ã€‚")

from google.colab import drive
import os

# æŽ›è¼‰é›²ç«¯ç¡¬ç¢Ÿ
drive.mount('/content/drive')

# ç¢ºèªæª”æ¡ˆæ˜¯å¦å­˜åœ¨ (é€™è¡Œæ˜¯ç‚ºäº†æª¢æŸ¥ç”¨ï¼Œç¢ºä¿è·¯å¾‘æ²’æ‰“éŒ¯)
file_path = '/content/drive/MyDrive/Colab Notebooks/123.txt'
if os.path.exists(file_path):
    print(f"âœ… æª”æ¡ˆè®€å–æˆåŠŸï¼š{file_path}")
else:
    print(f"âŒ æ‰¾ä¸åˆ°æª”æ¡ˆï¼Œè«‹æª¢æŸ¥è·¯å¾‘")

import time
import base64
import os
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.application import MIMEApplication
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

# ================= è¨­å®šå€ =================
# 1. æŒ‡å®šæ‚¨çš„ txt æª”æ¡ˆè·¯å¾‘
txt_file_path = '/content/drive/MyDrive/Colab Notebooks/123.txt'

# 2. è¨­å®š Email è³‡è¨Š
gmail_user = 'æ‚¨çš„Gmailå¸³è™Ÿ@gmail.com'
gmail_password = 'æ‚¨çš„æ‡‰ç”¨ç¨‹å¼å°ˆç”¨å¯†ç¢¼'
to_email = 'æ‚¨çš„å…¬å¸ä¿¡ç®±@company.com'
# ==========================================

# --- å•Ÿå‹•ç€è¦½å™¨ (åªå•Ÿå‹•ä¸€æ¬¡ï¼Œç¯€çœæ™‚é–“) ---
options = webdriver.ChromeOptions()
options.add_argument('--headless')
options.add_argument('--no-sandbox')
options.add_argument('--disable-dev-shm-usage')
options.add_argument('--disable-gpu')
options.add_argument('--window-size=1920,1080')
options.add_argument('--remote-debugging-port=9222')

try:
    driver = webdriver.Chrome(options=options)
    print("âœ… ç€è¦½å™¨å•Ÿå‹•æˆåŠŸï¼æº–å‚™é–‹å§‹æ‰¹æ¬¡ä½œæ¥­...")
except:
    options.binary_location = "/usr/bin/google-chrome"
    driver = webdriver.Chrome(options=options)
    print("âœ… ç€è¦½å™¨å•Ÿå‹•æˆåŠŸ (å‚™ç”¨æ¨¡å¼)ï¼")

try:
    # è®€å– txt æª”æ¡ˆä¸­çš„æ¯ä¸€è¡Œ
    with open(txt_file_path, 'r', encoding='utf-8') as f:
        lines = f.readlines()

    # --- é–‹å§‹å¤§è¿´åœˆï¼šä¸€è¡Œä¸€è¡ŒåŸ·è¡Œ ---
    for batch_index, line in enumerate(lines):
        query_numbers = line.strip() # åŽ»é™¤æ›è¡Œç¬¦è™Ÿ

        # å¦‚æžœæ˜¯ç©ºè¡Œå°±è·³éŽ
        if not query_numbers:
            continue

        print(f"\n==========================================")
        print(f"ðŸš€ æ­£åœ¨åŸ·è¡Œç¬¬ {batch_index + 1} æ‰¹æ¬¡")
        print(f"ðŸ“‹ çµ±ç·¨æ¸…å–®: {query_numbers}")
        print(f"==========================================")

        generated_pdfs = [] # æ¸…ç©º PDF æ¸…å–®ï¼Œæº–å‚™å­˜é€™ä¸€æ‰¹çš„

        # [å‹•ä½œ A] æœå°‹èˆ‡ä¸‹è¼‰
        try:
            driver.get("https://findbiz.nat.gov.tw/fts/query/QueryBar/queryInit.do")
            wait = WebDriverWait(driver, 20)

            # 1. åˆ‡æ›æ¨¡å¼
            try:
                btn = wait.until(EC.presence_of_element_located((By.XPATH, "//label[contains(text(),'å¤šçµ±ç·¨æŸ¥è©¢')]")))
                driver.execute_script("arguments[0].click();", btn)
                time.sleep(1)
            except:
                pass

            # 2. å‹¾é¸ [å…¬å¸] èˆ‡ [å•†æ¥­]
            try:
                cmpy_box = driver.find_element(By.XPATH, "//input[@value='isCmpy']")
                if not cmpy_box.is_selected(): driver.execute_script("arguments[0].click();", cmpy_box)

                bus_box = driver.find_element(By.XPATH, "//input[@value='isBus']")
                if not bus_box.is_selected(): driver.execute_script("arguments[0].click();", bus_box)
            except:
                pass

            # 3. è¼¸å…¥çµ±ç·¨ä¸¦æœå°‹
            input_box = wait.until(EC.presence_of_element_located((By.ID, "qryCond")))
            input_box.clear()
            input_box.send_keys(query_numbers)

            search_btn = driver.find_element(By.ID, "qryBtn")
            driver.execute_script("arguments[0].click();", search_btn)

            time.sleep(5) # ç­‰å¾…è³‡æ–™è¼‰å…¥

            # 4. å®šä½è³‡æ–™
            target_elements = driver.find_elements(By.XPATH, "//*[contains(text(), 'çµ±ä¸€ç·¨è™Ÿ')]/ancestor::tr//a | //*[contains(text(), 'çµ±ä¸€ç·¨è™Ÿ')]/ancestor::div[contains(@class, 'panel')]//a")
            valid_links_indices = [i for i, elem in enumerate(target_elements) if len(elem.text) > 4]

            # å‚™ç”¨å®šä½
            if not valid_links_indices:
                all_links = driver.find_elements(By.TAG_NAME, "a")
                valid_links_indices = [i for i, elem in enumerate(all_links) if len(elem.text) > 5 and "æ›´å¤š" not in elem.text and "æŒ‡å—" not in elem.text]

            print(f"   -> æœ¬æ‰¹æ¬¡æ‰¾åˆ° {len(valid_links_indices)} ç­†è³‡æ–™ï¼Œé–‹å§‹ä¸‹è¼‰...")

            # 5. ä¸‹è¼‰è¿´åœˆ
            count = 0
            for _ in valid_links_indices:
                count += 1
                try:
                    # é‡æ–°å®šä½
                    current_targets = driver.find_elements(By.XPATH, "//*[contains(text(), 'çµ±ä¸€ç·¨è™Ÿ')]/ancestor::tr//a | //*[contains(text(), 'çµ±ä¸€ç·¨è™Ÿ')]/ancestor::div[contains(@class, 'panel')]//a")
                    if not current_targets:
                        current_targets = [x for x in driver.find_elements(By.TAG_NAME, "a") if len(x.text) > 5 and "æ›´å¤š" not in x.text]

                    if count <= len(current_targets):
                        target = current_targets[count-1]
                        company_name = target.text # æŠ“å–å…¬å¸åç¨±æ–¹ä¾¿è¾¨è­˜
                        driver.execute_script("arguments[0].click();", target)
                        time.sleep(4)

                        # æª”ååŠ å…¥æ‰¹æ¬¡ç·¨è™Ÿï¼Œé¿å…é‡è¤‡
                        filename = f"Batch{batch_index+1}_{company_name}.pdf"
                        # è™•ç†æª”åä¸­å¯èƒ½æœ‰çš„éžæ³•å­—å…ƒ
                        filename = "".join([c for c in filename if c.isalpha() or c.isdigit() or c in ' ._-']).rstrip()

                        print_options = {
                            'landscape': False, 'displayHeaderFooter': False, 'printBackground': True,
                            'preferCSSPageSize': True, 'paperWidth': 8.27, 'paperHeight': 11.69
                        }
                        result = driver.execute_cdp_cmd("Page.printToPDF", print_options)

                        with open(filename, "wb") as f:
                            f.write(base64.b64decode(result['data']))

                        generated_pdfs.append(filename)
                        print(f"      [v] å·²ä¸‹è¼‰: {filename}")

                        driver.back()
                        time.sleep(2)
                except Exception as e:
                    print(f"      [x] ä¸‹è¼‰å¤±æ•—: {e}")
                    driver.back()
                    time.sleep(2)

        except Exception as e:
            print(f"   âš ï¸ æœ¬æ‰¹æ¬¡æœå°‹ç™¼ç”ŸéŒ¯èª¤: {e}")

        # [å‹•ä½œ B] å¯„é€ Email (é‡å°é€™ä¸€æ‰¹)
        if generated_pdfs:
            print(f"   ðŸ“§ æ­£åœ¨å¯„é€ç¬¬ {batch_index + 1} æ‰¹æ¬¡çš„ Email...")
            msg = MIMEMultipart()
            msg['Subject'] = f'å•†å·¥ç™»è¨˜æŸ¥è©¢çµæžœ - ç¬¬ {batch_index + 1} æ‰¹ (å…± {len(generated_pdfs)} ç­†)'
            msg['From'] = gmail_user
            msg['To'] = to_email

            body = f"é€™æ˜¯è‡ªå‹•åŒ–ç¨‹å¼åŸ·è¡Œçš„ç¬¬ {batch_index + 1} æ‰¹æ¬¡æŸ¥è©¢çµæžœã€‚\næŸ¥è©¢çµ±ç·¨ï¼š{query_numbers}\n\né™„ä»¶åŒ…å«ï¼š\n" + "\n".join(generated_pdfs)
            msg.attach(MIMEText(body, 'plain'))

            for pdf_file in generated_pdfs:
                with open(pdf_file, "rb") as f:
                    attach = MIMEApplication(f.read(), _subtype="pdf")
                    attach.add_header('Content-Disposition', 'attachment', filename=pdf_file)
                    msg.attach(attach)

            try:
                server = smtplib.SMTP('smtp.gmail.com', 587)
                server.starttls()
                server.login(gmail_user, gmail_password)
                server.send_message(msg)
                server.quit()
                print("   âœ… Email å¯„é€æˆåŠŸï¼")
            except Exception as e:
                print(f"   âŒ Email å¯„é€å¤±æ•—: {e}")
        else:
            print("   âš ï¸ æœ¬æ‰¹æ¬¡æ²’æœ‰ç”¢ç”Ÿä»»ä½• PDFï¼Œè·³éŽå¯„ä¿¡ã€‚")

        # ä¼‘æ¯ä¸€ä¸‹å†è·‘ä¸‹ä¸€æ‰¹ï¼Œé¿å…å°ç¶²ç«™é€ æˆè² æ“”
        print("   (ä¼‘æ¯ 5 ç§’å¾ŒåŸ·è¡Œä¸‹ä¸€æ‰¹...)")
        time.sleep(5)

    print("\nðŸŽ‰ðŸŽ‰ðŸŽ‰ æ‰€æœ‰æ‰¹æ¬¡ä½œæ¥­å…¨éƒ¨å®Œæˆï¼ ðŸŽ‰ðŸŽ‰ðŸŽ‰")

except Exception as e:
    print(f"è®€å–æª”æ¡ˆæˆ–åŸ·è¡ŒéŽç¨‹ç™¼ç”Ÿåš´é‡éŒ¯èª¤: {e}")

finally:
    driver.quit()